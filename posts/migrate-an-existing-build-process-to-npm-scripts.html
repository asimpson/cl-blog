<p>Last week I gave a short introduction to using npm as a build tool at <a href="http://gemcityjs.com">GemCity JS</a>.</p>
<div>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Here are the links and repo for my talk about &quot;NPM as a build tool&quot; at <a href="https://twitter.com/GemCityJS">@GemCityJS</a>.<a href="https://t.co/pByIGcRNpO">https://t.co/pByIGcRNpO</a></p>&mdash; Adam Simpson (@a_simpson) <a href="https://twitter.com/a_simpson/status/654693173667622914">October 15, 2015</a></blockquote>
</div>

<h2 id="rewrite-">Rewrite?</h2>
<p>There were a few questions about how to start using npm as a build tool on an existing project. The short answer is: start abstracting tasks behind <a href="https://docs.npmjs.com/misc/scripts">npm scripts</a>. This weekend I migrated this blog to <a href="https://chunkhost.com/r/46012">my new favorite host</a> and ended up replacing a <a href="http://gruntjs.com">grunt</a> task with a npm task. Here&#39;s how it went down.</p>
<h2 id="pick-a-task">Pick a task</h2>
<p>I was using two plugins, <a href="https://github.com/yeoman/grunt-usemin">grunt-usemin</a> and <a href="https://github.com/cbas/grunt-rev">grunt-rev</a>, to &quot;fingerprint&quot; or rev my asset files. It <em>barely</em> worked (only some files were properly rev&#39;d and inserted) and it was awkward. Usemin requires specific HTML comments so that it knows what files to replace. I finally decided to write my own rev task.</p>
<h2 id="the-old">The old</h2>
<p>For reference here is my old Grunt config:</p>
<pre class="language-coffeescript"> 
 rev:
  files:
    src: ["public/js/browser.js", "public/css/base.css"]

  usemin:
    html: 'server/app.hbs'
    options:
    assetsDirs: 'public/'

  useminPrepare:
    html: ['server/app-tmp.hbs']`
</pre>

<p>These tasks were run in this order during deployment: <code>rev, useminPrepare, usemin</code>.</p>
<h2 id="the-plan">The plan</h2>
<p>I stared off by jotting down the flow and transformations required for revving my assets. I came up with this list:</p>
<ol>
<li>Compile assets (sass, babel)</li>
<li>Rev them (this is just magic right?)</li>
<li>Overwrite non-rev&#39;d paths in <code>app.hbs</code>.</li>
</ol>
<p>That list was terribly shortsighted. Here&#39;s how it actually turned out:</p>
<ol>
<li>Compile assets</li>
<li>Generate rev filename for each asset</li>
<li>Write new asset file with rev&#39;d filename for each asset.</li>
<li>Create (force if necessary) <code>app.hbs</code> from <code>app-tmp.hbs</code> (-tmp for template)</li>
<li>Read <code>app.hbs</code> as a string.</li>
<li>Replace non-rev&#39;d paths with rev&#39;d paths in <code>app.hbs</code> using <code>String.replace()</code>.</li>
</ol>
<p>Seem like this might be more code and trouble than it&#39;s worth? Not at all.</p>
<h2 id="the-new-task">The new task</h2>
<p>Since we&#39;re going to replace a grunt task with a npm script task, lets use ES6 goodness. I <a href="https://babeljs.io">installed <code>babel</code></a> which lets me execute scripts <a href="https://babeljs.io/docs/usage/cli/#babel-node">using <code>babel-node</code> instead of <code>node</code></a>. I then created a new directory called <code>tasks/</code> and named my new task file, <code>tasks/rev.js</code>. I also installed the super awesome <a href="https://www.npmjs.com/package/rev-file">rev-file</a> package to handle the reving.</p>
<p>The code turns out to be fairly succicent:</p>
<pre class="language-javascript"> 
import rev from "rev-file";
import path from "path";
import fs from "fs-extra";

const projectPath= path.dirname(__dirname);
const tmp = `${projectPath}/server/app-tmp.hbs`;
const app = `${projectPath}/server/app.hbs`;

fs.copySync(tmp, app, {'clobber': true});

const assets = [
  `${projectPath}/public/css/base.css`,
  `${projectPath}/public/js/browser.js`
];

assets.forEach((f) => {
  const revPath = rev.sync(f);
  fs.copySync(f, revPath);
  const appString = fs.readFileSync(app, 'utf8');
  fs.writeFileSync(app, appString.replace( path.basename(f), path.basename(revPath) ));
});
</pre>

<h2 id="wrap-it-up">Wrap it up</h2>
<p>Now I have a task. How do I integrate this into my existing Grunt process? <a href="https://docs.npmjs.com/misc/scripts">npm scripts</a> to the rescue. I created a new script entry in my <code>package.json</code> like this:</p>
<pre class="language-javascript">   
"scripts": {
  "start": "node ./bin/www",
  "rev": "babel-node tasks/rev.js"
}
</pre>

<p>npm scripts can be called directly using <code>npm run</code>, <code>npm run rev</code> in this case. The final step is to modify my <code>Gruntfile</code> to run the rev command using the handy <a href="https://github.com/sindresorhus/grunt-shell">grunt shell plugin</a>:</p>
<pre class="language-coffeescript"> 
  shell:
    rev:
      command: "npm run rev"
</pre>

<p>And that&#39;s all I had to do. Now I can continue to replace pieces of my build system with npm scripts without having to do a big re-write. Using npm as a build tool also illustrates the simplicity of some of these tasks. It&#39;s much easier to maintain a 20 line task than to keep multiple plugins up to date.</p>
